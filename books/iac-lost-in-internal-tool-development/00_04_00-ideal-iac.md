---
title: "反復に耐えうる環境を提供する IaC"
---

## 開発は継続するもの

たとえ小さなアプリケーションだとしても初期リリース以降も、**Feedback** を元にコード改修は繰り返します。 内製ツールの場合は特に**使いやすさ (Usability)** を高めていくことは会社のパフォーマンスにつながるでしょう。

:::message
偶に最初の要件定義段階でこれ以上仕様変更しないように要求元に圧をかける姿が想像されますが、それを行ったところで市場からあふれる変化の圧力が止まることはありません。結局、改善要求が降りかかるか、せっかく開発されたツールが使われなくなるか、あるいは改善したいことがあっても声を出せない環境を作り出すでしょう。
:::

[![Image from Gyazo](https://i.gyazo.com/9be5519fd4f9e12bbf652ca7d1efcca0.png)](https://gyazo.com/9be5519fd4f9e12bbf652ca7d1efcca0)

改善を行っていくにはコード自身に対する**変更容易性 (Modifiability) や運用性 (Operability)** を確保し、継続的に発生する**運用コストを最小化**しなければなりません[^why_operability_is_important]。

[^why_operability_is_important]: 基本的に楽でない運用はミスを誘発[^why_operability_is_important_2]し、運用者にプレッシャーを与えるだけでなく、建設的なコード改善に当てる工数を奪います。
[^why_operability_is_important_2]:
    運用現場は楽じゃないとミスが起こる
    [Infrastructure as Code でセキュリティを楽にしよう ! #AWSDevLiveShow - YouTube](https://www.youtube.com/live/qr_Fx_ENjxE?si=tGnLqBipnMmpTqlh&t=380)

必然的にアプリケーションは何度も改修され、細かくデプロイすることが求められます[^may_not_deploy_because_of_low_deployability]。
そこで「環境構築とデプロイ」レイヤに求められるのが **デプロイ容易性 (Deployability)** であり、**再構築性 (Reconstructability)** です。

[^may_not_deploy_because_of_low_deployability]: 本当にそんなに deploy するのか？と思った人がいるかも知れませんが、その場合は Deployability が低く触る勇気が持てないから次の deploy が起こらない可能性があります。

## 求められる性質

まず、「環境構築とデプロイ」のレイヤに求められる性質のうち、上のレイヤに特に大きな影響を及ぼすと考えるものを 2 つに絞って上げたいと思います。

- 再構築性 (Reconstructability)
- デプロイ容易性 (Deployability)

### 再構築性 (Reconstructability)

「一度デプロイした環境をゼロから再構築できる性質」のことをここでは「再構築性 (Reconstructability)」と呼ぶことにします[^definition_of_each_ility]。

[^definition_of_each_ility]: ソフトウェア品質を表す指標 (Ilities) の定義は多少異なることがあるかもしれません。本書内ではこの定義をしますという意味です。

前チャプターで手動デプロイした例を上げましたが、あのままでは再構築性が皆無です。 なにかの弾みで環境が吹き飛んだときに同じ環境を作れる保証が無いからです。
依存関係のアプリケーションからデータベースまでをゼロから構築するスクリプトは最低限必要でしょう。

スクリプト化することは以下のような恩恵をもたらします。

- バージョン管理ができる
- 可逆性を持つ[^software_can_be_rollback] (何かあったときに過去のバージョンに戻ることができる)
- 改善の手を加える勇気をもたらす (戻る技術は安全に進む技術)[^rollbackability_is_a_safe_technology_to_move_forward]

[^software_can_be_rollback]:
    しかし, ほとんどの決定はそのようなものではなく, 変更可能で, 可逆的で, 双方向のドアです.
    もしあなたがこうしたタイプ 2 の決定で最適でない決定をしてしまったとしても, その結果に長く耐える必要はありません.
    扉を開けて, また戻ればいいのです.
    タイプ 2 の決定は, 判断力の高い個人や少人数のグループが迅速に行えますし, そうすべきです.
    (ジェフ・ベゾス、Amazon 株主への手紙（2015） 『モノリスからマイクロサービスへ』)

[^rollbackability_is_a_safe_technology_to_move_forward]: [基調講演: 私の開発ワークフロー (和田 卓人) - REDMINE JAPAN Vol.2 - YouTube](https://www.youtube.com/watch?v=IQ7lDefJLtk&t=1135s&ab_channel=RedmineJapan)

まず、スクリプト化されているということは、どうやってその環境を作り出したかが正確に記述されているということです (正確性については IaC の項目で後述)。
最新のコミットが現在の環境を表すということは、その環境を **reviewable** にし、透明性を高めることに繋がります。
一人で開発していると誰も見てくれるはずがないとふてくされるかもしれませんが、少なくとも 1 ヶ月後のあなたは、過去の自分に感謝し、それを市場の変化と戦う武器としていることでしょう。
また、本当に誰も見てくれないと決めつけるのは早計です。Reviewable なシステムはアーキテクチャ構造をオープンに示すことができ、理解をしたいけど情報が曖昧だから参画してこなかった人々には届くはずです。学ぶ気はあるのにその機会を得られない人を生み出す損失は大きいです。

さて、話を戻して、次に「可逆」であるということは「環境構築とデプロイ」レイヤ自身が最適化やセキュリティ要求を満たすために、インフラ構成を変更するリスクを減らします。容易に様々な環境を parallel に試す機会になるのです。
これは「ツール開発」レイヤにとっても同じことです。いくらでも複製可能で、 廃棄容易な環境 (Disposability) は思い切った変更やこまめな動作確認を促進させるでしょう。

結論、再構築性がもたらす可逆性は手を動かすエンジニアたちに変更することへの **勇気を与える役割** をもつといえます。

### デプロイ容易性 (Deployability)

デプロイ容易性 (Deployability) とは、端的に言うとできるだけコストを抑え、どれだけスムーズにコミットされた内容を本番に反映できるかということです[^definition_of_each_ility]。

前セクションの例で我々は最低限の要件のみを定義し開発をスタートさせました。 アジャイル的な開発では頻繁なフィードバックサイクルを回すために、小さな改修を反復的でインクリメンタルに行うべきです。
複数の機能を追加してからまとめてリリースするよりも、マイナーな機能単位でリリースしたほうがこのサイクルはよく周ります。

この要求に応えるには当然、**デプロイコストはほぼゼロ**であることが望ましいです。

最新の変更を反映するコマンドを用意しておくことも一つの手ですが、デプロイ先のサーバーに近づきすぎると、サーバーへの依存 (Device-Dependence) の強い処理を不意に組み込んでしまうおそれがあるため、抽象化できているとなお良いです。
Continuous Deployment までできれば理想的ですが、その準備の再構築性もしっかり確保しておきたいところです。

## IaC

この本を読んでいる方は既に理解しているかもしれませんが、 IaC とは Infrastructure as Code の略で、インフラの状態 (ハードウェア ～ サーバー内部構成等) を宣言的に表現し、構築・設定・管理を自動化することを指します。 IaC はまさに「環境構築とデプロイ」レイヤに求められる役割を果たす最適な概念と言えるでしょう。

実際に IaC を得意とした有名なツールはいくつかあり以下のようなものが挙げられます。

- Kubernetes (K8s)
- Terraform
- AWS CDK (AWS CloudFormation)
- Ansible
- Puppet
- Chef

本書では具体的なツールの使い方は扱いませんが、これらのツールをうまく使うことで、**統一的な記法と管理**で**数多のサービスやツールを支える**ことができます。

Kubernetes 等は非常に宣言的なので再構築性が高いですが、たとえそれ以外のツールにしても、自動化されたデプロイを定期的に新しい環境に展開することで再構築性を担保しても良いと考えます。

また、ツール作成時に、アプリケーション開発者は設定値を定数や config ファイルとしてコードリポジトリに push したくなることでしょう。 しかし、[「III. Config」 (The Twelve-Factor App)](https://12factor.net/config)にある通り、アプリケーション側にデプロイ先関連の情報を含めることは悪手となります。
そこでしっかりと事前に IaC の基盤を作り、「デプロイ先情報は IaC 側で受け持つ」という棲み分けとその文化をチームに広げることで、環境への依存から解放されたツール開発が可能になります[^need_communication_between_tool_developer_and_deployer]。

[^need_communication_between_tool_developer_and_deployer]: もちろん、ツール開発者とデプロイ環境管理者の間でのコミュニケーションを惜しまないようにしましょう。

[![Image from Gyazo](https://i.gyazo.com/f66f4f300f0ec5a377f28fe074f1fb18.png)](https://gyazo.com/f66f4f300f0ec5a377f28fe074f1fb18)

## 組織編成的な視点

(2024/01/23 次のページに分離しました。)
