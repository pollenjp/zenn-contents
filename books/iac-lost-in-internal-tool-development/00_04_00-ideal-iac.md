---
title: "理想的なIaC管理"
---

本セクションでは「環境構築とデプロイ」レイヤが継続的なツール開発を支えるためにはどのような姿であるべきかを考えていきます。

[![Image from Gyazo](https://i.gyazo.com/9be5519fd4f9e12bbf652ca7d1efcca0.png)](https://gyazo.com/9be5519fd4f9e12bbf652ca7d1efcca0)

## 求められる性質

まず、「環境構築とデプロイ」のレイヤに求められる性質のうち、上のレイヤに特に大きな影響を及ぼすと考えるものを 3 つに絞って上げたいと思います。

- 再構築性 (Reconstructability)
- 可監査性 (Auditability)
- デプロイ容易性 (Deployability)

### 再構築性と可監査性 (Reconstructability & Auditability)

「一度デプロイした環境をゼロから再構築できる性質」、それをここでは「再構築性 (Reconstructability)」と呼ぶことにします[^reconstructability]。

[^reconstructability]: ソフトウェア品質を表す指標 (Ilities) の定義は人によって異なることがあるためこのような表現をしています。

前セクションで手動デプロイした例を上げましたが、あのままでは再構築性が皆無です。 なにかの弾みで環境が吹き飛んだときに同じ環境を作れる保証が無いからです。
依存関係のアプリケーションからデータベースまでをゼロから構築するスクリプトは最低限必要でしょう。

スクリプト化することは以下のような恩恵をもたらします。

- バージョン管理ができる
- 可逆性を持つ[^software_can_be_rollback] (何かあったときに過去のバージョンに戻ることができる)
- 戻る技術は安全に進む技術であり、我々に改善の手を加える勇気をもたらす[^rollbackability_is_a_safe_technology_to_move_forward]

[^software_can_be_rollback]:
    しかし, ほとんどの決定はそのようなものではなく, 変更可能で, 可逆的で, 双方向のドアです.
    もしあなたがこうしたタイプ 2 の決定で最適でない決定をしてしまったとしても, その結果に長く耐える必要はありません.
    扉を開けて, また戻ればいいのです.
    タイプ 2 の決定は, 判断力の高い個人や少人数のグループが迅速に行えますし, そうすべきです.
    (ジェフ・ベゾス、Amazon 株主への手紙（2015） 『モノリスからマイクロサービスへ』)

[^rollbackability_is_a_safe_technology_to_move_forward]: [基調講演: 私の開発ワークフロー (和田 卓人) - REDMINE JAPAN Vol.2 - YouTube](https://www.youtube.com/watch?v=IQ7lDefJLtk&t=1135s&ab_channel=RedmineJapan)

まず、スクリプト化されているということは、どうやってその環境を作り出したかが正確に記述されているということです (正確性については IaC の項目で後述)。
最新のコミットが現在の環境を表すということは、その環境を **reviewable** にし、 **Auditability (可監査性)** を高めたことになります。
一人で開発していると誰も見てくれるはずがないとふてくされるかもしれませんが、少なくとも 1 ヶ月後のあなたは、過去の自分に感謝し、それを市場の変化と戦う武器としていることでしょう。
また、本当に誰も見てくれないと決めつけるのは早計です。auditability を担保したシステムは透明性を持ち、理解をしたいと思っている隠れた人々には届くはずです。学ぶ気はあるのにその機会を得られない人を生み出す損失は大きいです。

さて、話を戻して、次に「可逆」であるということは「環境構築とデプロイ」レイヤ自身が最適化やセキュリティ要求を満たすために、インフラ構成を変更するリスクを減らし、様々な環境を試す機会を与えます。
これは「ツール開発」レイヤにとっても同じことです。いくらでも複製可能で、 廃棄容易な環境 (Disposability) は思い切った変更やこまめな動作確認を促進させるでしょう。

すなわち、再構築性がもたらす可逆性は手を動かすエンジニアたちに変更することへの **勇気を与える役割** をもつといえます。

### デプロイ容易性 (Deployability)

デプロイ容易性 (Deployability) とは、端的に言うとできるだけコストを抑え、どれだけスムーズにコミットされた内容を本番に反映できるかということです。

前セクションの例で我々は最低限の要件のみを定義し開発をスタートさせました。 アジャイル的な開発では頻繁なフィードバックサイクルを回すために、小さな改修を反復的でインクリメンタルに行うべきです。
複数の機能を追加してからまとめてリリースするよりも、マイナーな機能単位でリリースしたほうがこのサイクルはよく周ります。

この要求に応えるには当然、「環境構築とデプロイ」レイヤの **デプロイコストはほぼゼロ** であることが望ましいです。

最新の変更を反映するコマンドを用意しておくことも一つの手ですが、デプロイ先のサーバーに近づきすぎると、サーバーへの依存 (Device-Dependence) の強い処理を不意に組み込んでしまうおそれがあるため、抽象化できているとなお良いです。
Continuous Deployment までできれば理想的ですが、その準備の再構築性もしっかり確保しておきましょう。

## IaC

この本を読んでいる方は既に理解しているかもしれませんが、 IaC とは Infrastructure as Code の略で、インフラの状態 (ハードウェア ～ サーバー内部構成等) を記述的に表現し、構築・設定・管理を自動化することを指します。

IaC はまさに「環境構築とデプロイ」レイヤに求められる役割を果たす最適な概念と言えるでしょう。
実際に IaC を得意とした有名なツールはいくつかあり以下のようなものが挙げられます。

- Kubernetes (K8s)
- Terraform
- AWS CDK (AWS CloudFormation)
- Ansible
- Puppet
- Chef

本書では具体的なツールの使い方は扱いませんが、これらのツールをうまく使うことで、数多のサービスやツールを支えることができます。

Kubernetes 等は非常に宣言的なので、再構築性が高いですが、たとえそれ以外のツール出会ったとしても、自動化されたデプロイを定期的に新しい環境に展開することで再構築性を担保しても良いと考えます。

また、ツール作成時に、アプリケーション開発者は設定値を定数や config ファイルとしてコードリポジトリに push したくなることでしょう。 しかし、[The Twelve-Factor App「III. Config」](https://12factor.net/config)にある通り、アプリケーション側にデプロイ先に依存した情報を含めることは悪手となります。
そこでしっかりと事前に IaC の基盤を作っておくことで、デプロイ先依存の情報は IaC 側で受け持つ棲み分けができ、環境への依存から解放されたツール開発が可能になります。

[![Image from Gyazo](https://i.gyazo.com/f66f4f300f0ec5a377f28fe074f1fb18.png)](https://gyazo.com/f66f4f300f0ec5a377f28fe074f1fb18)

## 組織編成的な視点

(2024/01/23 次のページに分離しました。)
